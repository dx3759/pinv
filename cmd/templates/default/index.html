<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>{{ appInfo "appname" }} 轻量文件管理系统 {{ appInfo "version" }}</title>
    <link rel="stylesheet" type="text/css" href="/statics/libs/layui-v2.6.13/layui/css/layui.css" />
    <!-- <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
    <link rel="stylesheet" type="text/css" href="/statics/css/main.css" />
    
</head>


<script type="text/tpl" id="mkdir">
    <div class="layui-row" style="text-align:center;">
        <div class="layui-form-item" style="padding:20px;">
            <input type="text" name="dirname" required="" lay-verify="required" placeholder="文件夹名称" autocomplete="off" class="layui-input">        
        </div>
        <button class="layui-btn createdir">创建</button>
    </div>
</script>


<!-- <script type="text/tpl" id="sys_info">
    <div class="layui-row" style="padding:20px;">
        <table class="layui-table">
            <tr><td>UPnP</td><td>ok</td><td>29.78.98.100:8080</td></tr>
        </table>
    </div>
</script> -->



<body>
    <div style="position: fixed; top: 0; right: 0; border: 0; z-index:9999;">
        <a target="_blank" href="https://github.com/yzimhao/ymfile" class="github-corner"aria-label="View source on GitHub"><svg width="80"height="80"viewBox="0 0 250 250"style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; right: 0;"aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"fill="currentColor"style="transform-origin: 130px 106px;"class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"fill="currentColor"class="octo-body"></path></svg></a><style>.github-corner:hover.octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media(max-width:500px){.github-corner:hover.octo-arm{animation:none}.github-corner.octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    </div>

    <div id="sys_info" style="display: none;" >
        <div class="layui-row" style="padding:20px;">
            <table class="layui-table">
                <col width="100"></col>
                <col width="50"></col>
                <col></col>

                <tr class="external_ip"><td>ExternalIP</td><td></td><td></td></tr>
                <tr class="upnp"><td>UPnP</td><td></td><td></td></tr>
            </table>
        </div>
    </div>


    <div class="layui-main">
        <div class="layui-container">
            <div class="layui-header header">
                <div class="layui-col-md2 logo"><span class="appName">{{ appInfo "appname" }}</span><span class="appVer">{{ appInfo "version" }}</span></div>
                <div class="layui-col-md2 right-icon">
                    <a href="javascript:;" class="sys_info"><i class="layui-icon layui-icon-console"></i></a>
                    <a href="javascript:;" class="sys_set"><i class="layui-icon layui-icon-set"></i></a>                    
                </div>
            </div>

            <div class="layui-row tools">
                <div class="layui-col-md12">
                    <button type="button" class="layui-btn layui-btn-normal" id="action_upload">上传</button>
                    <button type="button" class="layui-btn layui-btn-normal actbtn" action="download">下载</button>
                    <button type="button" class="layui-btn layui-btn-normal actbtn" action="refresh">刷新</button>
                    <button type="button" class="layui-btn layui-btn-normal actbtn" action="mkdir">新建文件夹</button>
                    
                    <button type="button" class="layui-btn layui-btn-danger actbtn" action="delete">删除选择</button>
                </div>
            </div>

            <div class="layui-row explorer-main">
                <div class="layui-row curr-menu">
                    <div class="layui-col-md5">当前路径: <span class="current_path">/</span></div>
                    <div class="layui-col-md4 stats">3个文件夹 20个文件</div>
                </div>
                
                <div class="layui-row">
                    <table id="file-explorer" class="layui-table" lay-skin="nob" lay-size="lg"></table>
                </div>
            </div>
            


            <div class="layui-footer footer">
                <p>Copyright © 2022 <a href="https://github.com/yzimhao/ymfile" target="_blank">{{ appInfo "appname" }} {{ appInfo "version" }}</a> MIT Licensed</p>
            </div>


            <div class="upload_list_area layui-bg-gray">
                <div class="close"><i class="layui-icon layui-icon-close-fill"></i></div>
                <div class="layui-upload">
                    <div class="layui-upload-list">
                      <table class="layui-table">
                        <colgroup>
                          <col>
                          <col>
                          <col width="260">
                          <col width="150">
                        </colgroup>
                        <thead>
                          <tr><th>文件名</th>
                          <th>大小</th>
                          <th>上传进度</th>
                          <th>操作</th>
                        </tr></thead>
                        <tbody id="fileUploadList"></tbody>
                      </table>
                    </div>
                    <div style="text-align: center;">
                        <button type="button" class="layui-btn" id="uploadListAction">开始上传</button>
                    </div>
                  </div>
            </div>
        </div>
    </div>




<script src="/statics/libs/layui-v2.6.13/layui/layui.js"></script>
<script src="/statics/js/main.js"></script>
<!--您的Layui代码start-->
<script type="text/javascript">
    layui.use(['laydate', 'layer','element', 'upload', 'tree', 'util', 'table'], function () {
        var laydate = layui.laydate //日期
            , layer = layui.layer //弹层
            , $ = layui.$
            , tree = layui.tree
            , util = layui.util
            , upload = layui.upload
            , table = layui.table
            , element = layui.element;

        var loadMainInfo = function(){
            $.ajax({
                url: "/api/v1/main",
                type: "GET",
                success: function(d){
                    if(d.ok){
                        $(".appName").html(d.data.app_name);
                        $(".appVer").html(d.data.app_version)
                       
                        console.log(d.data.support);
                        
                        var upnp = d.data.support.UPnP;
                        var tr_upnp = $("#sys_info").find("table tr.upnp");
                        tr_upnp.find("td:eq(1)").html(function(){
                            if(upnp.Enable){
                                return "support";
                            }
                            return "unknown";
                        });
                        tr_upnp.find("td:eq(2)").html(function(){
                            if(upnp.Enable){
                                return "//" + upnp.ExternalIP+":" + upnp.RemotePort;
                            }
                        });

                    }
                }
            })
        };

        var currentPath = ["/"];
        var updateCurrentPath = function(next){
            if(next == "../" && currentPath.length > 1){
                currentPath.splice(currentPath.length-1, 1);
            }else if(next == "../" && currentPath.length == 1){
                //nothing
            }else{
                currentPath.push(next);
            }
            console.log("set", currentPath);
            $(".current_path").html(getCurrentPath());
            reloadFilesExplorer();
        };
        var getCurrentPath = function(){
            console.log("get", currentPath);
            return currentPath.join("");
        };
        

        var loadFiles = function(){
            var current_path = getCurrentPath();
            table.render({
                elem: '#file-explorer'
                ,url: '/api/v1/filelist?current_path='+ current_path
                ,page: false
                ,parseData: function(res){
                    return {
                        "code": res.ok == true ? 0 : 1,
                        "msg": res.reason,
                        "data": res.data.files
                    };
                }
                ,cols: [[
                {field: 'a', title: '', type:'checkbox'},
                    {field: 'name', title: '名称', sort: true, templet:function(d){
                        if(d.is_dir){
                            var txt = "<a class='childdir' href='javascript:;'>";
                            txt += '<i class="layui-icon layui-icon-export"></i>' + d.name;
                            txt += "</a>";
                            return txt;
                        }else{
                            var icon = "";
                            switch(d.content_type){
                                case 'image/gif':
                                case 'image/jpeg':
                                case 'image/png':
                                case 'image/bmp':
                                case 'image/webp':
                                case 'image/x-icon':
                                    icon = '<i class="layui-icon layui-icon-picture"></i>'; break;

                                case 'application/pdf':
                                    icon = '<i class="layui-icon layui-icon-picture"></i>'; break;
                                default:
                                    icon = '<i class="layui-icon layui-icon-file-b"></i>';
                            }

                            return icon +" "+ d.name;
                        }
                    }}
                    ,{field: 'size', title: '大小', sort: true, templet: function(d){
                        if(d.is_dir){
                           return "-"; 
                        }
                        return d.size;
                    }}
                    ,{field: 'last_modified', title: '修改时间', sort: true, templet: function(d){
                        return util.toDateString(d.last_modified * 1000);
                    }}
                ]]
            });
        };
        
        var reloadFilesExplorer = function(){ loadFiles();};



        $(".close").on("click", function(){
            $(".upload_list_area").hide();
        });
        $(".actbtn").on("click", function(){
            var act = $(this).attr("action");
            if (act== "mkdir"){
                layer.open({
                    type: 1,
                    area: ['500px', '300px'], 
                    title: "新建文件夹名称",
                    content: $("#mkdir").html()
                });
            }else if( act == "refresh"){
                reloadFilesExplorer();
            }else if(act == "download"){
                var checkObj = $(".layui-table input[type=checkbox]:checked"); 
                if(checkObj.length == 0){
                    layer.msg("请选择需要下载的文件");
                    return;
                }

                checkObj.each(function(){
                    var filename = $(this).parents("tr").find("td:eq(1)").attr("data-content");
                    var downloadUrl = "/api/v1/download?current_path="+getCurrentPath()+"&filename="+ filename;
                    window.open(downloadUrl);
                });
                
                
            }else if(act == "delete"){                
                var checkObj = $(".layui-table input[type=checkbox]:checked"); 
                
                if(checkObj.length > 0){

                    layer.confirm("删除无法恢复，请再次确认是否删除?", {
                        title: "删除确认",
                        btn: ["确认删除", "取消"],
                    }, function(){
                        var needDel = [];
                        var current_path = getCurrentPath();
                        checkObj.each(function(){
                            needDel.push($(this).parents("tr").find("td:eq(1)").attr("data-content"))
                        });

                        console.log(needDel, current_path);
                        $.ajax({
                            url: "/api/v1/delete",
                            type: "POST",
                            data: {
                                "current_path": current_path,
                                "filename": needDel
                            },
                            success: function(d){
                                if(d.ok){
                                    reloadFilesExplorer();
                                    layer.close(layer.index);                                    
                                }
                            }

                        });
                    }, function(){
                        layer.close(layer.index);
                    });
                    
                }
            }
        });
        //创建文件夹
        $("body").on("click", ".createdir", function(){
            var name = $("input[name=dirname]").val();
            if(name != ""){
                $.ajax({
                    url:  "/api/v1/createdir",
                    type: "POST",
                    data: {
                        current_path: getCurrentPath(),
                        dirname: name
                    },
                    success: function(d){
                        if(!d.ok){
                            return layer.msg(d.reason);
                        }
                        layer.close(layer.index);
                        reloadFilesExplorer();
                    }
                })
            }            
        });
        //进入子文件夹
        $("body").on("click", ".childdir", function(){
            var dirname = $(this).parents("td").attr("data-content");
            updateCurrentPath(dirname+"/");
            uploadListIns.reload({
                url: '/api/v1/upload?current_path='+ getCurrentPath()
            });
        });
        //sys_info
        $("body").on("click", ".sys_info", function(){
            layer.open({
                type: 1,
                area: ['800px', '600px'], 
                title: "系统信息",
                content: $("#sys_info").html()
            });
        })



        //多文件列表上传
        var uploadListIns = upload.render({
            elem: '#action_upload' //绑定元素
            ,elemList: $('#fileUploadList') //列表元素对象
            ,url: '/api/v1/upload?current_path='+ getCurrentPath()
            ,accept: 'file'
            ,multiple: true
            ,number: 30
            ,auto: true
            ,bindAction: '#uploadListAction'
            ,choose: function(obj){ 
                $(".upload_list_area").show();
                
                var that = this;
                var files = this.files = obj.pushFile();
                //读取本地文件
                obj.preview(function(index, file, result){
                    var tr = $(['<tr id="upload-'+ index +'">'
                    ,'<td>'+ file.name +'</td>'
                    ,'<td>'+ (file.size/1014).toFixed(1) +'kb</td>'
                    ,'<td><div class="layui-progress" lay-filter="progress-demo-'+ index +'"><div class="layui-progress-bar" lay-percent=""></div></div></td>'
                    ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                    ,'</td>'
                    ,'</tr>'].join(''));
                
                    //单个重传
                    tr.find('.demo-reload').on('click', function(){
                        obj.upload(index, file);
                    });
                
                    //删除
                    tr.find('.demo-delete').on('click', function(){
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });
                
                    that.elemList.append(tr);
                    element.render('progress'); //渲染新加的进度条组件
                });
            }
            ,done: function(res, index, upload){ //成功的回调
                var that = this;
                if(res.ok){ //上传成功
                    var tr = that.elemList.find('tr#upload-'+ index)
                    ,tds = tr.children();
                    tds.eq(3).html(''); //清空操作
                    delete this.files[index]; //删除文件队列已经上传成功的文件
                    
                    reloadFilesExplorer();
                    tr.remove();
                    return;
                }
                this.error(index, upload);
            }
            ,allDone: function(obj){ //多文件上传完毕后的状态回调
                $(".upload_list_area").hide();
            }
            ,error: function(index, upload){ //错误回调
                var that = this;
                var tr = that.elemList.find('tr#upload-'+ index)
                ,tds = tr.children();
                tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
            }
            ,progress: function(n, elem, e, index){ //注意：index 参数为 layui 2.6.6 新增
                element.progress('progress-demo-'+ index, n + '%'); //执行进度条。n 即为返回的进度百分比
            }
        });


        loadMainInfo();
        loadFiles();     

    });
</script>
</html>